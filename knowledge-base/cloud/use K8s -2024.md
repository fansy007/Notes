# 1ã€èµ„æºåˆ›å»ºæ–¹å¼
- å‘½ä»¤è¡Œ
- YAML 

# 2ã€Namespace
> åç§°ç©ºé—´ç”¨æ¥éš”ç¦»èµ„æº

```bash
kubectl create ns hello
kubectl delete ns hello

kubectl delete -f hello.yaml
```
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: hello
```
# 3ã€Pod
> è¿è¡Œä¸­çš„ä¸€ç»„å®¹å™¨ï¼ŒPodæ˜¯kubernetesä¸­åº”ç”¨çš„æœ€å°å•ä½.

![image.png](https://cdn.nlark.com/yuque/0/2021/png/1613913/1625484036923-09a15ef3-33dc-4e29-91e4-e7fbc69070ce.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_YXRndWlndS5jb20gIOWwmuehheiwtw%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10#averageHue=%23e5bb40&height=365&id=im3wk&originHeight=926&originWidth=982&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104244&status=done&style=none&title=&width=387)
```bash
kubectl run mynginx --image=nginx

# æŸ¥çœ‹defaultåç§°ç©ºé—´çš„Pod
kubectl get pod 
# æè¿°
kubectl describe pod ä½ è‡ªå·±çš„Podåå­—
# åˆ é™¤
kubectl delete pod Podåå­—
# æŸ¥çœ‹Podçš„è¿è¡Œæ—¥å¿—
kubectl logs Podåå­—

# æ¯ä¸ªPod - k8séƒ½ä¼šåˆ†é…ä¸€ä¸ªip
kubectl get pod -owide
# ä½¿ç”¨Podçš„ip+podé‡Œé¢è¿è¡Œå®¹å™¨çš„ç«¯å£
curl 192.168.169.136

# é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªæœºå™¨ä»¥åŠä»»æ„çš„åº”ç”¨éƒ½èƒ½é€šè¿‡Podåˆ†é…çš„ipæ¥è®¿é—®è¿™ä¸ªPod

```
```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    run: mynginx
  name: mynginx
#  namespace: default
spec:
  containers:
  - image: nginx
    name: mynginx
```
```yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    run: myapp
  name: myapp
spec:
  containers:
  - image: nginx
    name: nginx
  - image: tomcat:8.5.68
    name: tomcat
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1613913/1625553938232-51976552-5bab-4c98-bb8d-c4bf612bf866.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_YXRndWlndS5jb20gIOWwmuehheiwtw%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10#averageHue=%23fcffff&height=192&id=FpsZ8&originHeight=256&originWidth=518&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9742&status=done&style=stroke&title=&width=389)
_**æ­¤æ—¶çš„åº”ç”¨è¿˜ä¸èƒ½å¤–éƒ¨è®¿é—®**_

# 4ã€Deployment
> æ§åˆ¶Podï¼Œä½¿Podæ‹¥æœ‰å¤šå‰¯æœ¬ï¼Œè‡ªæ„ˆï¼Œæ‰©ç¼©å®¹ç­‰èƒ½åŠ›

```bash
# æ¸…é™¤æ‰€æœ‰Podï¼Œæ¯”è¾ƒä¸‹é¢ä¸¤ä¸ªå‘½ä»¤æœ‰ä½•ä¸åŒæ•ˆæœï¼Ÿ
kubectl run mynginx --image=nginx

kubectl create deployment mytomcat --image=tomcat:8.5.68
# è‡ªæ„ˆèƒ½åŠ›


```

## 1ã€å¤šå‰¯æœ¬
```bash
kubectl create deployment my-dep --image=nginx --replicas=3
```
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: my-dep
  name: my-dep
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-dep
  template:
    metadata:
      labels:
        app: my-dep
    spec:
      containers:
      - image: nginx
        name: nginx
```


## 2ã€æ‰©ç¼©å®¹
```bash
kubectl scale --replicas=5 deployment/my-dep
```
```bash
kubectl edit deployment my-dep

#ä¿®æ”¹ replicas
```

## 3ã€è‡ªæ„ˆ&æ•…éšœè½¬ç§»

- åœæœº
- åˆ é™¤Pod
- å®¹å™¨å´©æºƒ
- ....


## 4ã€æ»šåŠ¨æ›´æ–°
```bash
kubectl set image deployment/my-dep nginx=nginx:1.16.1 --record
kubectl rollout status deployment/my-dep
```

```yaml
# ä¿®æ”¹ kubectl edit deployment/my-dep
```

## 5ã€ç‰ˆæœ¬å›é€€
```bash
#å†å²è®°å½•
kubectl rollout history deployment/my-dep


#æŸ¥çœ‹æŸä¸ªå†å²è¯¦æƒ…
kubectl rollout history deployment/my-dep --revision=2

#å›æ»š(å›åˆ°ä¸Šæ¬¡)
kubectl rollout undo deployment/my-dep

#å›æ»š(å›åˆ°æŒ‡å®šç‰ˆæœ¬)
kubectl rollout undo deployment/my-dep --to-revision=2
```

> æ›´å¤šï¼š
> é™¤äº†Deploymentï¼Œk8sè¿˜æœ‰ `StatefulSet` ã€`DaemonSet` ã€`Job`  ç­‰ ç±»å‹èµ„æºã€‚æˆ‘ä»¬éƒ½ç§°ä¸º `å·¥ä½œè´Ÿè½½`ã€‚
> æœ‰çŠ¶æ€åº”ç”¨ä½¿ç”¨  `StatefulSet`  éƒ¨ç½²ï¼Œæ— çŠ¶æ€åº”ç”¨ä½¿ç”¨ `Deployment` éƒ¨ç½²
> [https://kubernetes.io/zh/docs/concepts/workloads/controllers/](https://kubernetes.io/zh/docs/concepts/workloads/controllers/)


# 5ã€Service
> å°†ä¸€ç»„ [Pods](https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/) å…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æŠ½è±¡æ–¹æ³•ã€‚

```bash
#æš´éœ²Deploy
kubectl expose deployment my-dep --port=8000 --target-port=80
# æŒ‡çš„æ˜¯å¤–éƒ¨æœåŠ¡ --port=8000
# pod çš„ç«¯å£

#ä½¿ç”¨æ ‡ç­¾æ£€ç´¢Pod
kubectl get pod -l app=my-dep
```
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: my-dep
  name: my-dep
spec:
  selector:
    app: my-dep
  ports:
  - port: 8000
    protocol: TCP
    targetPort: 80
```

## 1ã€ClusterIP

kubectl get pod --show-labels
è¾“å‡º my-dep

kubectl get service
è¾“å‡º service ipåœ°å€

åŸŸå
æœåŠ¡å.åå­—ç©ºé—´.svc
my-app.default.svc -- this is only being used inside pod, outside not aware of it

--type=ClusterIP # é›†ç¾¤ipåªèƒ½åœ¨é›†ç¾¤å†…è®¿é—®
```bash
# ç­‰åŒäºæ²¡æœ‰--typeçš„
kubectl expose deployment my-dep --port=8000 --target-port=80 --type=ClusterIP
```
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: my-dep
  name: my-dep
spec:
  ports:
  - port: 8000
    protocol: TCP
    targetPort: 80
  selector:
    app: my-dep
  type: ClusterIP
```
## 2ã€NodePort
æš´éœ²å‡ºæ¥çš„æ˜¯å…¬ç½‘
```bash
kubectl expose deployment my-dep --port=8000 --target-port=80 --type=NodePort
```
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: my-dep
  name: my-dep
spec:
  ports:
  - port: 8000
    protocol: TCP
    targetPort: 80
  selector:
    app: my-dep
  type: NodePort

```
> NodePortèŒƒå›´åœ¨ 30000-32767 ä¹‹é—´ï¼Œipæ˜¯å¤–éƒ¨æœºå™¨çš„ip

# 6ã€Ingress
![[Pasted image 20240511151155.png|825]]
Ingress is service's entrance

ç»Ÿä¸€çš„ç½‘å…³å…¥å£
ingresså¯¹service è¿›è¡Œäº†åŸŸåæ˜ å°„ my-app.default.svc -> hostname:port

ingress hostname -> service ->  pod

## 1ã€å®‰è£…
```bash
wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/baremetal/deploy.yaml

#ä¿®æ”¹é•œåƒ
vi deploy.yaml
#å°†imageçš„å€¼æ”¹ä¸ºå¦‚ä¸‹å€¼ï¼š
registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0

# æ£€æŸ¥å®‰è£…çš„ç»“æœ
kubectl get pod,svc -n ingress-nginx

# æœ€ååˆ«å¿˜è®°æŠŠsvcæš´éœ²çš„ç«¯å£è¦æ”¾è¡Œ
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1613913/1631010459687-252bb01e-e532-4992-830b-c097cddf9935.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_YXRndWlndS5jb20gIOWwmuehheiwtw%3D%3D%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10#averageHue=%231b1a1b&clientId=ua23ed450-5d56-4&from=paste&height=20&id=uaa83fba9&originHeight=39&originWidth=1718&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15169&status=done&style=none&taskId=u6b8658ba-97af-4180-9641-dd952c76e4b&title=&width=859)
ingress ä¹Ÿä¼šæš´éœ²ä¸¤ä¸ªnodePortç«¯å£ 80


> å¦‚æœä¸‹è½½ä¸åˆ°ï¼Œç”¨ä»¥ä¸‹æ–‡ä»¶

kubectl apply -f ingress.yaml

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx

---
# Source: ingress-nginx/templates/controller-serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx
  namespace: ingress-nginx
automountServiceAccountToken: true
---
# Source: ingress-nginx/templates/controller-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx-controller
  namespace: ingress-nginx
data:
---
# Source: ingress-nginx/templates/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
  name: ingress-nginx
rules:
  - apiGroups:
      - ''
    resources:
      - configmaps
      - endpoints
      - nodes
      - pods
      - secrets
    verbs:
      - list
      - watch
  - apiGroups:
      - ''
    resources:
      - nodes
    verbs:
      - get
  - apiGroups:
      - ''
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
  - apiGroups:
      - extensions
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingresses/status
    verbs:
      - update
  - apiGroups:
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingressclasses
    verbs:
      - get
      - list
      - watch
---
# Source: ingress-nginx/templates/clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
  name: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx
subjects:
  - kind: ServiceAccount
    name: ingress-nginx
    namespace: ingress-nginx
---
# Source: ingress-nginx/templates/controller-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx
  namespace: ingress-nginx
rules:
  - apiGroups:
      - ''
    resources:
      - namespaces
    verbs:
      - get
  - apiGroups:
      - ''
    resources:
      - configmaps
      - pods
      - secrets
      - endpoints
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ''
    resources:
      - services
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingresses/status
    verbs:
      - update
  - apiGroups:
      - networking.k8s.io   # k8s 1.14+
    resources:
      - ingressclasses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ''
    resources:
      - configmaps
    resourceNames:
      - ingress-controller-leader-nginx
    verbs:
      - get
      - update
  - apiGroups:
      - ''
    resources:
      - configmaps
    verbs:
      - create
  - apiGroups:
      - ''
    resources:
      - events
    verbs:
      - create
      - patch
---
# Source: ingress-nginx/templates/controller-rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx
subjects:
  - kind: ServiceAccount
    name: ingress-nginx
    namespace: ingress-nginx
---
# Source: ingress-nginx/templates/controller-service-webhook.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx-controller-admission
  namespace: ingress-nginx
spec:
  type: ClusterIP
  ports:
    - name: https-webhook
      port: 443
      targetPort: webhook
  selector:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/component: controller
---
# Source: ingress-nginx/templates/controller-service.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  type: NodePort
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: http
    - name: https
      port: 443
      protocol: TCP
      targetPort: https
  selector:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/component: controller
---
# Source: ingress-nginx/templates/controller-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: controller
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/instance: ingress-nginx
      app.kubernetes.io/component: controller
  revisionHistoryLimit: 10
  minReadySeconds: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/component: controller
    spec:
      dnsPolicy: ClusterFirst
      containers:
        - name: controller
          image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0
          imagePullPolicy: IfNotPresent
          lifecycle:
            preStop:
              exec:
                command:
                  - /wait-shutdown
          args:
            - /nginx-ingress-controller
            - --election-id=ingress-controller-leader
            - --ingress-class=nginx
            - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller
            - --validating-webhook=:8443
            - --validating-webhook-certificate=/usr/local/certificates/cert
            - --validating-webhook-key=/usr/local/certificates/key
          securityContext:
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE
            runAsUser: 101
            allowPrivilegeEscalation: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LD_PRELOAD
              value: /usr/local/lib/libmimalloc.so
          livenessProbe:
            failureThreshold: 5
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 10254
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
            - name: https
              containerPort: 443
              protocol: TCP
            - name: webhook
              containerPort: 8443
              protocol: TCP
          volumeMounts:
            - name: webhook-cert
              mountPath: /usr/local/certificates/
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 90Mi
      nodeSelector:
        kubernetes.io/os: linux
      serviceAccountName: ingress-nginx
      terminationGracePeriodSeconds: 300
      volumes:
        - name: webhook-cert
          secret:
            secretName: ingress-nginx-admission
---
# Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml
# before changing this value, check the required kubernetes version
# https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  name: ingress-nginx-admission
webhooks:
  - name: validate.nginx.ingress.kubernetes.io
    matchPolicy: Equivalent
    rules:
      - apiGroups:
          - networking.k8s.io
        apiVersions:
          - v1beta1
        operations:
          - CREATE
          - UPDATE
        resources:
          - ingresses
    failurePolicy: Fail
    sideEffects: None
    admissionReviewVersions:
      - v1
      - v1beta1
    clientConfig:
      service:
        namespace: ingress-nginx
        name: ingress-nginx-controller-admission
        path: /networking/v1beta1/ingresses
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ingress-nginx-admission
  annotations:
    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  namespace: ingress-nginx
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ingress-nginx-admission
  annotations:
    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
rules:
  - apiGroups:
      - admissionregistration.k8s.io
    resources:
      - validatingwebhookconfigurations
    verbs:
      - get
      - update
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ingress-nginx-admission
  annotations:
    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx-admission
subjects:
  - kind: ServiceAccount
    name: ingress-nginx-admission
    namespace: ingress-nginx
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ingress-nginx-admission
  annotations:
    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  namespace: ingress-nginx
rules:
  - apiGroups:
      - ''
    resources:
      - secrets
    verbs:
      - get
      - create
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ingress-nginx-admission
  annotations:
    helm.sh/hook: pre-install,pre-upgrade,post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx-admission
subjects:
  - kind: ServiceAccount
    name: ingress-nginx-admission
    namespace: ingress-nginx
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: ingress-nginx-admission-create
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  namespace: ingress-nginx
spec:
  template:
    metadata:
      name: ingress-nginx-admission-create
      labels:
        helm.sh/chart: ingress-nginx-3.33.0
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/version: 0.47.0
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: admission-webhook
    spec:
      containers:
        - name: create
          image: docker.io/jettech/kube-webhook-certgen:v1.5.1
          imagePullPolicy: IfNotPresent
          args:
            - create
            - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc
            - --namespace=$(POD_NAMESPACE)
            - --secret-name=ingress-nginx-admission
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      restartPolicy: OnFailure
      serviceAccountName: ingress-nginx-admission
      securityContext:
        runAsNonRoot: true
        runAsUser: 2000
---
# Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: ingress-nginx-admission-patch
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
  labels:
    helm.sh/chart: ingress-nginx-3.33.0
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/version: 0.47.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: admission-webhook
  namespace: ingress-nginx
spec:
  template:
    metadata:
      name: ingress-nginx-admission-patch
      labels:
        helm.sh/chart: ingress-nginx-3.33.0
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/version: 0.47.0
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: admission-webhook
    spec:
      containers:
        - name: patch
          image: docker.io/jettech/kube-webhook-certgen:v1.5.1
          imagePullPolicy: IfNotPresent
          args:
            - patch
            - --webhook-name=ingress-nginx-admission
            - --namespace=$(POD_NAMESPACE)
            - --patch-mutating=false
            - --secret-name=ingress-nginx-admission
            - --patch-failure-policy=Fail
          env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      restartPolicy: OnFailure
      serviceAccountName: ingress-nginx-admission
      securityContext:
        runAsNonRoot: true
        runAsUser: 2000
```


## 2ã€ä½¿ç”¨
> å®˜ç½‘åœ°å€ï¼š[https://kubernetes.github.io/ingress-nginx/](https://kubernetes.github.io/ingress-nginx/)
> å°±æ˜¯nginxåšçš„


### 1ã€åŸŸåè®¿é—®
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress  
metadata:
  name: ingress-host-bar
spec:
  ingressClassName: nginx
  rules:
  - host: "hg.com"
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: helloapp
            port:
              number: 8080
```


> é—®é¢˜ï¼š path: "/nginx" ä¸  path: "/" ä¸ºä»€ä¹ˆä¼šæœ‰ä¸åŒçš„æ•ˆæœï¼Ÿ


### 2ã€è·¯å¾„é‡å†™



```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress  
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  name: ingress-host-bar
spec:
  ingressClassName: nginx
  rules:
  - host: "hg.com"
    http:
      paths:
      - pathType: Prefix
        path: "/hello(/|$)(.*)" -- æŒ‡çš„æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ä¸è¦ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¿ç•™ï¼Œ /hello/abc/efg -> /hello/efg
        backend:
          service:
            name: helloapp
            port:
              number: 8080
```
### 3ã€æµé‡é™åˆ¶
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-limit-rate
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: "1"
spec:
  ingressClassName: nginx
  rules:
  - host: "hg.com"
    http:
      paths:
      - pathType: Exact
        path: "/"
        backend:
          service:
            name: helloapp
            port:
              number: 8000
```
### 4. visit ingress out side
```powershell
 kubectl get svc -A
# result
# ingress-nginx 80:30133/TCP,443:30489/TCP   33m

```

> http://192.168.31.80:30133
> https://192.168.31.80:30489
> 

change windows C:\Windows\System32\drivers\etc\hosts
```shell
192.168.31.80 hg.com
```
visit
[http://hg.com:30133/hello](http://hg.com:30133/hello)
[http://hg.com:30133/hello/hello](http://hg.com:30133/hello/hello) (è·¯å¾„é‡å†™)

# 7ã€å­˜å‚¨æŠ½è±¡
## ç¯å¢ƒå‡†å¤‡
### 1ã€æ‰€æœ‰èŠ‚ç‚¹
```bash
#æ‰€æœ‰æœºå™¨å®‰è£…
yum install -y nfs-utils
```
### 2ã€ä¸»èŠ‚ç‚¹
```shell
#nfsä¸»èŠ‚ç‚¹
echo "/nfs/data/ *(insecure,rw,sync,no_root_squash)" > /etc/exports

mkdir -p /nfs/data
systemctl enable rpcbind --now
systemctl enable nfs-server --now
#é…ç½®ç”Ÿæ•ˆ
exportfs -r
```
query by
```shell
exportfs
```

### 3ã€ä»èŠ‚ç‚¹
```bash
showmount -e 192.168.31.80

#æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŒ‚è½½ nfs æœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•åˆ°æœ¬æœºè·¯å¾„ /root/nfsmount
mkdir -p /nfs/data

mount -t nfs 192.168.31.80:/nfs/data /nfs/data
# å†™å…¥ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
echo "hello nfs server" > /nfs/data/test.txt
```

### 4ã€åŸç”Ÿæ–¹å¼æ•°æ®æŒ‚è½½
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-pv-demo
  name: nginx-pv-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-pv-demo
  template:
    metadata:
      labels:
        app: nginx-pv-demo
    spec:
      containers:
      - image: nginx
        name: nginx
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
        - name: html
          nfs:
            server: 192.168.31.80
            path: /nfs/data/nginx-pv
```
create files inside /nfs/data/nginx-pv

[http://192.168.31.80:31394/](http://192.168.31.80:31394/)


## 1ã€PV&PVC
> _PVï¼šæŒä¹…å·ï¼ˆPersistent Volumeï¼‰ï¼Œå°†åº”ç”¨éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ä¿å­˜åˆ°æŒ‡å®šä½ç½®_
> _PVCï¼šæŒä¹…å·ç”³æ˜ï¼ˆPersistent Volume Claimï¼‰ï¼Œç”³æ˜éœ€è¦ä½¿ç”¨çš„æŒä¹…å·è§„æ ¼_

### 1ã€åˆ›å»ºpvæ± 
> é™æ€ä¾›åº”

```bash
#nfsä¸»èŠ‚ç‚¹
mkdir -p /nfs/data/01
mkdir -p /nfs/data/02
mkdir -p /nfs/data/03
```
> åˆ›å»ºPV

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv01-10m
spec:
  capacity:
    storage: 10M
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/01
    server: 172.31.0.4
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv02-1gi
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/02
    server: 172.31.0.4
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv03-3gi
spec:
  capacity:
    storage: 3Gi
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/03
    server: 172.31.0.4
```



### 2ã€PVCåˆ›å»ºä¸ç»‘å®š

kubectl get persistentvolumn
pv å¼€å‡ºç‰©ç†è·¯å¾„çš„ç©ºé—´

pvcæ˜¯ä½¿ç”¨ç©ºé—´çš„ç”³è¯·ä¹¦ï¼Œä½†æ˜¯ä¸ç”¨æ‰‹åŠ¨æŒ‡å®špv


> åˆ›å»ºPVC

```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: nginx-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 200Mi
  storageClassName: nfs
```

> åˆ›å»ºPodç»‘å®šPVC

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-deploy-pvc
  name: nginx-deploy-pvc
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-deploy-pvc
  template:
    metadata:
      labels:
        app: nginx-deploy-pvc
    spec:
      containers:
      - image: nginx
        name: nginx
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
        - name: html
          persistentVolumeClaim:
            claimName: nginx-pvc
```
PVC will use whatever PV space to store data
## 2ã€ConfigMap
> æŠ½å–åº”ç”¨é…ç½®ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨æ›´æ–°

æŒ‚è½½æ–‡ä»¶
### 1ã€redisç¤ºä¾‹

vi redis.conf
```shell
appendonly yes
```
#### 1ã€æŠŠä¹‹å‰çš„é…ç½®æ–‡ä»¶åˆ›å»ºä¸ºé…ç½®é›†
```bash
# åˆ›å»ºé…ç½®ï¼Œredisä¿å­˜åˆ°k8sçš„etcdï¼›
kubectl create cm redis-conf --from-file=redis.conf
```

kubectl get cm

```yaml
apiVersion: v1
data:    #dataæ˜¯æ‰€æœ‰çœŸæ­£çš„æ•°æ®ï¼Œkeyï¼šé»˜è®¤æ˜¯æ–‡ä»¶å   valueï¼šé…ç½®æ–‡ä»¶çš„å†…å®¹
  redis.conf: |
    appendonly yes
kind: ConfigMap
metadata:
  name: redis-conf
  namespace: default
```

#### 2ã€åˆ›å»ºPod
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: redis
spec:
  containers:
  - name: redis
    image: redis
    command:
      - redis-server
      - "/redis-master/redis.conf"  #æŒ‡çš„æ˜¯rediså®¹å™¨å†…éƒ¨çš„ä½ç½®
    ports:
    - containerPort: 6379
    volumeMounts:
    - mountPath: /data
      name: data
    - mountPath: /redis-master
      name: config
  volumes:
    - name: data
      emptyDir: {}
    - name: config
      configMap:
        name: redis-conf
        items:
        - key: redis.conf
          path: redis.conf
```
 - mountPath: /redis-master
      name: config
->
    - name: config
      configMap:
        name: redis-conf  (this is pre defined in config map)
        items:
        - key: redis.conf (property in  config map:  redis-conf)
          path: redis.conf (create a file under folder /redis-master)

#### 
#### 3ã€æ£€æŸ¥é»˜è®¤é…ç½®
```bash
kubectl exec -it redis -- redis-cli

127.0.0.1:6379> CONFIG GET appendonly
127.0.0.1:6379> CONFIG GET requirepass
```


#### 4ã€ä¿®æ”¹ConfigMap

kubectl edit cm redis-conf
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: example-redis-config
data:
  redis-config: |
    maxmemory 2mb
    maxmemory-policy allkeys-lru 
```
#### 5ã€æ£€æŸ¥é…ç½®æ˜¯å¦æ›´æ–°
```bash
kubectl exec -it redis -- redis-cli

127.0.0.1:6379> CONFIG GET maxmemory
127.0.0.1:6379> CONFIG GET maxmemory-policy
```
> æ£€æŸ¥æŒ‡å®šæ–‡ä»¶å†…å®¹æ˜¯å¦å·²ç»æ›´æ–°
> ä¿®æ”¹äº†CMã€‚Podé‡Œé¢çš„é…ç½®æ–‡ä»¶ä¼šè·Ÿç€å˜


> _**é…ç½®å€¼æœªæ›´æ”¹ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¯åŠ¨ Pod æ‰èƒ½ä»å…³è”çš„ ConfigMap ä¸­è·å–æ›´æ–°çš„å€¼ã€‚ **_
> _**åŸå› ï¼šæˆ‘ä»¬çš„Podéƒ¨ç½²çš„ä¸­é—´ä»¶è‡ªå·±æœ¬èº«æ²¡æœ‰çƒ­æ›´æ–°èƒ½åŠ›**_

_can use_
_kubectl delete pod XXXX, to trigger deployment again _

## 3ã€Secret
> Secret å¯¹è±¡ç±»å‹ç”¨æ¥ä¿å­˜æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€OAuth ä»¤ç‰Œå’Œ SSH å¯†é’¥ã€‚ å°†è¿™äº›ä¿¡æ¯æ”¾åœ¨ secret ä¸­æ¯”æ”¾åœ¨ [Pod](https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/) çš„å®šä¹‰æˆ–è€… [å®¹å™¨é•œåƒ](https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-image) ä¸­æ¥è¯´æ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚

create secret docker-registry -- means docker hub related secret
```bash
kubectl create secret docker-registry hg-docker \
--docker-username=hg26502 \
--docker-password=Yunfei@002 \
--docker-email=qjgeng@gmail.com

##å‘½ä»¤æ ¼å¼
kubectl create secret docker-registry regcred \
  --docker-server=<ä½ çš„é•œåƒä»“åº“æœåŠ¡å™¨> \
  --docker-username=<ä½ çš„ç”¨æˆ·å> \
  --docker-password=<ä½ çš„å¯†ç > \
  --docker-email=<ä½ çš„é‚®ç®±åœ°å€>
```
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: private-nginx
spec:
  containers:
  - name: private-nginx
    image: hgapp:1.0
  imagePullSecrets:
  - name: hg-docker
```

# pull image and use proxy
set proxy
![[Pasted image 20240801195402.png|825]]
```sh
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://01uinh3k.mirror.aliyuncs.com"
  ]
}
```


```sh
docker pull nicolaka/netshoot
```

# running net shoot 
```sh
docker run --rm nicolaka/netshoot ping -c 4 www.baidu.com
docker run --rm -it nicolaka/netshoot bash. (ctrl+Dé€€å‡º)
```

# install minikube
set mirrow first
```sh
/etc/docker/daemon.json

  "registry-mirrors": [
    "https://01uinh3k.mirror.aliyuncs.com"
  ]
```

å®‰è£…
```sh
brew install minikube
minikube start ï¼ˆminikube deleteï¼Œ minikube stopï¼‰
```

ä½¿ç”¨
```sh
kubectl apply -f test.yaml (kubectl delete -f test.yaml) 
```


# Kubectl å®é™…æ“ä½œ

```sh
k exec -it my-nginx-fc567748-vnw6b --/bin/sh


k (help info)
k rollout -h (help info)

k get all --show-labels
kÂ get all
k get svc
k get deployment
k get pods
k logs XXXX
k describle pod XXXX 
```

deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-nginx
spec:
  selector:
    matchLabels:
      app: my-web
      tier: front-end
  replicas: 3
  strategy:
      # indicate which strategy we want for rolling update
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0
  template:
    metadata:
      labels:
        app: my-web
        tier: front-end
        svc: my-svc
    spec:
      containers:
      - name: my-nginx
        image: nginx:1.20-alpine-perl
        ports:
        - containerPort: 80

```

service
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-svc  # Service çš„åç§°
spec:
  selector:
    app: my-web       # é€‰æ‹©æœ‰è¿™ä¸ªæ ‡ç­¾çš„ Pods
    tier: front-end   # é€‰æ‹©æœ‰è¿™ä¸ªæ ‡ç­¾çš„ Pods
  ports:
  - port: 80
    targetPort: 80
  type: NodePort
```
ç­‰ä»·äº k expose my-nginx --port=80 --type=NodePort

æŸ¥çœ‹
```sh
(base) hg26502@192 deploy-service % minikube service my-svc
|-----------|--------|-------------|---------------------------|
| NAMESPACE |  NAME  | TARGET PORT |            URL            |
|-----------|--------|-------------|---------------------------|
| default   | my-svc |          80 | http://192.168.49.2:32608 |
|-----------|--------|-------------|---------------------------|
ğŸƒ  ä¸ºæœåŠ¡ my-svc å¯åŠ¨éš§é“ã€‚
|-----------|--------|-------------|------------------------|
| NAMESPACE |  NAME  | TARGET PORT |          URL           |
|-----------|--------|-------------|------------------------|
| default   | my-svc |             | http://127.0.0.1:62160 |
|-----------|--------|-------------|------------------------|
```